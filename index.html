<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tier List MLBB</title>
  <link rel="stylesheet" href="css/estilo.css">
  <style>
    .hero-routes img { height: 18px; vertical-align: middle; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <h1>Tier List - Mobile Legends</h1>
  <label for="rank">Rank:</label>
  <select id="rank">
    <option value="mythic">Mythic</option>
    <option value="legend">Legend</option>
    <option value="epic">Epic</option>
    <option value="grandmaster">Grandmaster</option>
    <option value="master">Master</option>
    <option value="elite">Elite</option>
    <option value="warrior">Warrior</option>
  </select>
  <label for="days">Dias:</label>
  <select id="days">
    <option value="1">1</option>
    <option value="3">3</option>
    <option value="7" selected>7</option>
    <option value="15">15</option>
    <option value="30">30</option>
  </select>
  <button onclick="carregarTierList()">Atualizar</button>

  <div class="tier-box tier-ss">
    <div class="tier-label ss">SS</div>
    <div id="tier-ss" class="tier-container"></div>
  </div>
  <div class="tier-box tier-s">
    <div class="tier-label s">S</div>
    <div id="tier-s" class="tier-container"></div>
  </div>
  <div class="tier-box tier-a">
    <div class="tier-label a">A</div>
    <div id="tier-a" class="tier-container"></div>
  </div>
  <div id="filter-section">
    <h2>Filtrar por Função e Rota</h2>
    <label for="role">Função:</label>
    <select id="role">
      <option value="">Todas</option>
      <option value="mage">Mage</option>
      <option value="marksman">Marksman</option>
      <option value="tank">Tank</option>
      <option value="assassin">Assassin</option>
      <option value="fighter">Fighter</option>
      <option value="support">Support</option>
    </select>
    <label for="lane">Rota:</label>
    <select id="lane">
      <option value="">Todas</option>
      <option value="mid">Mid</option>
      <option value="gold">Gold</option>
      <option value="exp">EXP</option>
      <option value="jungle">Jungle</option>
      <option value="roam">Roam</option>
    </select>
    <button onclick="filtrarTierList()">Buscar</button>
  </div>
  <script>
    // Mapeamento ID <-> Nome dos heróis (pegue do seu endpoint real!)
    let heroIdToName = {};
    let heroNameToId = {};
    // Armazenamento de info extra por id (role/rotas)
    let heroExtraInfo = {};
    // Tierlist original para filtro/reset
    let tierCards = [];

    // Carrega o dicionário de id para nome
    function fetchHeroMap() {
      return fetch('https://mlbb-proxy.vercel.app/api/hero-list')
        .then(res => res.json())
        .then(map => {
          heroIdToName = map;
          heroNameToId = {};
          Object.entries(map).forEach(([id, name]) => {
            heroNameToId[name] = id;
          });
        });
    }

    // Carrega info de posição (rotas/função) para todos os heróis
    function fetchAllHeroPositions() {
      // Pega todos (role=all, lane=all, size=127, index=1)
      return fetch('https://mlbb-proxy.vercel.app/api/hero-position?role=all&lane=all&size=127&index=1')
        .then(res => res.json())
        .then(json => {
          heroExtraInfo = {};
          (json.data.records || []).forEach(entry => {
            const heroData = entry.data;
            heroExtraInfo[String(heroData.hero_id)] = {
              // role principal (primeiro sortid)
              role: (heroData.hero && heroData.hero.data && heroData.hero.data.sortid && heroData.hero.data.sortid.length && heroData.hero.data.sortid[0] && heroData.hero.data.sortid[0].data && heroData.hero.data.sortid[0].data.sort_title) ? heroData.hero.data.sortid[0].data.sort_title.toLowerCase() : "",
              // rotas
              roadsort: (heroData.hero && heroData.hero.data && heroData.hero.data.roadsort) ? heroData.hero.data.roadsort : []
            };
          });
        });
    }

    // Monta a tierlist
    function carregarTierList() {
      const rank = document.getElementById('rank').value;
      const days = document.getElementById('days').value;
      const url = `https://mlbb-proxy.vercel.app/api/hero-rank?source=rank&days=${days}&rank=${rank}&size=130&sort_field=win_rate&sort_order=desc`;

      document.getElementById('tier-ss').innerHTML = '';
      document.getElementById('tier-s').innerHTML = '';
      document.getElementById('tier-a').innerHTML = '';
      tierCards = [];

      // Carrega tudo em paralelo, só monta quando tiver tudo pronto
      Promise.all([fetchHeroMap(), fetchAllHeroPositions(), fetch(url).then(res => res.json())])
        .then(([_, __, json]) => {
          const records = json.data.records || [];

          records.forEach(entry => {
            const hero = entry.data.main_hero.data;
            const winRate = (entry.data.main_hero_win_rate * 100).toFixed(1);

            // Descobre o id do herói pelo nome
            const heroId = heroNameToId[hero.name];
            // Pega info extra
            const info = heroExtraInfo[heroId] || {};
            const role = info.role || '';
            // Rotas
            let roadsortTitles = [];
            let roadsortHtml = '';
            if (Array.isArray(info.roadsort)) {
              roadsortTitles = info.roadsort.map(rs => (rs.data && rs.data.road_sort_title) ? rs.data.road_sort_title : '').filter(Boolean);
              roadsortHtml = info.roadsort.map(rs => {
                const data = rs.data || {};
                return `
                  <span class="hero-route">
                    ${data.road_sort_icon ? `<img src="${data.road_sort_icon}" alt="${data.road_sort_title}" title="${data.road_sort_title}">` : ''}
                    ${data.road_sort_title || ''}
                  </span>
                `;
              }).join('');
            }

            const el = document.createElement('div');
            el.className = 'card';
            el.setAttribute('data-role', role);
            el.setAttribute('data-routes', roadsortTitles.join('|').toLowerCase());
            el.setAttribute('data-id', heroId || '');
            el.setAttribute('data-name', hero.name);
            el.innerHTML = `
              <img src="${hero.head}" alt="${hero.name}">
              <div class="hero-name">${hero.name}</div>
              <div class="hero-meta">${winRate}% WR</div>
              <div class="hero-routes">${roadsortHtml}</div>
            `;

            tierCards.push(el);

            if (winRate >= 54) {
              document.getElementById('tier-ss').appendChild(el);
            } else if (winRate >= 51) {
              document.getElementById('tier-s').appendChild(el);
            } else {
              document.getElementById('tier-a').appendChild(el);
            }
          });
        })
        .catch(err => {
          console.error("Erro ao carregar tier list:", err);
        });
    }

    // Filtra os cards já existentes na tierlist
    function filtrarTierList() {
      const role = document.getElementById('role').value.toLowerCase();
      const lane = document.getElementById('lane').value.toLowerCase();

      document.querySelectorAll('.tier-container .card').forEach(card => {
        const heroRole = (card.getAttribute('data-role') || '').toLowerCase();
        const heroRoutes = (card.getAttribute('data-routes') || '').toLowerCase();
        let mostra = true;
        if (role && !heroRole.includes(role)) mostra = false;
        if (lane && !heroRoutes.includes(lane)) mostra = false;
        card.classList.toggle('hidden', !mostra);
      });
    }

    // Carrega tierlist ao iniciar
    carregarTierList();
  </script>
</body>
</html>
