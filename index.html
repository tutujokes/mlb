<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>moba.gg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Tier List Mobile Legends - Atualizado e filtrável por função, rota, rank e idioma.">
  <link rel="stylesheet" href="css/estilo.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body data-theme="light">
  <header class="header-moba">
    <span class="logo-moba">moba.gg</span>
    <div class="header-actions">
      <button id="themeSwitch" class="theme-switch" title="Modo claro/escuro">
        <i id="themeIcon" class="fa-solid fa-moon"></i>
      </button>
      <div class="lang-switch-wrap">
        <button id="langSwitch" class="lang-switch" title="Trocar idioma">
          <span id="langFlag" class="flag" style="background-image:url('https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/br.svg');"></span>
        </button>
        <div id="flagDropdown" class="flag-dropdown hidden">
          <span class="flag-option selected" id="flagBR" style="background-image:url('https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/br.svg');" data-lang="pt-BR" tabindex="0" aria-label="Português (Brasil)"></span>
          <span class="flag-option" id="flagUS" style="background-image:url('https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/us.svg');" data-lang="en-US" tabindex="0" aria-label="English (US)"></span>
        </div>
      </div>
    </div>
  </header>

  <main class="main-moba">
    <h1 class="main-title" data-i18n="title">Tier List - Mobile Legends</h1>
    <div class="filters-row">
      <div class="filter-group">
        <label for="rank" data-i18n="rank_label">Rank:</label>
        <select id="rank">
          <option value="mythic" data-i18n="rank_mythic">Mítico</option>
          <option value="legend" data-i18n="rank_legend">Lenda</option>
          <option value="epic" data-i18n="rank_epic">Épico</option>
          <option value="grandmaster" data-i18n="rank_grandmaster">Grão-mestre</option>
          <option value="master" data-i18n="rank_master">Mestre</option>
          <option value="elite" data-i18n="rank_elite">Elite</option>
          <option value="warrior" data-i18n="rank_warrior">Guerreiro</option>
        </select>
        <label for="days" data-i18n="days_label" style="margin-left:18px;">Dias:</label>
        <select id="days">
          <option value="1" data-i18n="days_1">1</option>
          <option value="3" data-i18n="days_3">3</option>
          <option value="7" selected data-i18n="days_7">7</option>
          <option value="15" data-i18n="days_15">15</option>
          <option value="30" data-i18n="days_30">30</option>
        </select>
      </div>
    </div>
    <div class="filters-row bg-alt">
      <div class="filter-group">
        <label for="role" data-i18n="role_label">Função:</label>
        <select id="role">
          <option value="" data-i18n="all_roles">Todas</option>
          <option value="mage" data-i18n="role_mage">Mago</option>
          <option value="marksman" data-i18n="role_marksman">Atirador</option>
          <option value="tank" data-i18n="role_tank">Tanque</option>
          <option value="assassin" data-i18n="role_assassin">Assassino</option>
          <option value="fighter" data-i18n="role_fighter">Lutador</option>
          <option value="support" data-i18n="role_support">Suporte</option>
        </select>
        <label for="lane" data-i18n="lane_label" style="margin-left:18px;">Rota:</label>
        <select id="lane">
          <option value="" data-i18n="all_lanes">Todas</option>
          <option value="mid" data-i18n="lane_mid">Meio</option>
          <option value="gold" data-i18n="lane_gold">Ouro</option>
          <option value="exp" data-i18n="lane_exp">EXP</option>
          <option value="jungle" data-i18n="lane_jungle">Selva</option>
          <option value="roam" data-i18n="lane_roam">Rotação</option>
        </select>
      </div>
    </div>
    <div class="tier-box tier-ss">
      <div class="tier-label ss">SS</div>
      <div id="tier-ss" class="tier-container"></div>
    </div>
    <div class="tier-box tier-s">
      <div class="tier-label s">S</div>
      <div id="tier-s" class="tier-container"></div>
    </div>
    <div class="tier-box tier-a">
      <div class="tier-label a">A</div>
      <div id="tier-a" class="tier-container"></div>
    </div>
    <div id="noResults" class="no-results hidden" data-i18n="no_heroes">Nenhum herói encontrado.</div>
  </main>

  <footer class="footer-moba">
    <span class="footer-brand">moba.gg &reg; 2025</span>
    <a class="byarthur" href="https://github.com/tutujokes" target="_blank" rel="noopener" aria-label="GitHub">
      Arthur Henrique
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" class="inline ml-1">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 2C6.48 2 2 6.48 2 12c0 4.41 2.87 8.14 6.84 9.49.5.09.66-.21.66-.47
          0-.23-.01-.84-.01-1.65-2.78.6-3.37-1.34-3.37-1.34-.45-1.15-1.11-1.46-1.11-1.46-.91-.62.07-.6.07-.6
          1 .07 1.53 1.03 1.53 1.03.89 1.52 2.34 1.08 2.91.82.09-.65.35-1.08.64-1.33
          -2.22-.25-4.56-1.11-4.56-4.95 0-1.09.39-1.99 1.03-2.69-.1-.25-.45-1.27.1-2.65
          0 0 .84-.27 2.75 1.02a9.56 9.56 0 012.5-.34c.85 0 1.7.11 2.5.34
          1.9-1.29 2.75-1.02 2.75-1.02.55 1.38.2 2.4.1 2.65.64.7 1.03 1.6 1.03 2.69
          0 3.85-2.34 4.7-4.57 4.95.36.31.69.93.69 1.88 0 1.36-.01 2.46-.01 2.8
          0 .26.16.57.67.47A10.004 10.004 0 0022 12c0-5.52-4.48-10-10-10z"/>
      </svg>
    </a>
  </footer>

  <script>
    // Traduções
    const translations = {
      'pt-BR': {
        title: "Tier List - Mobile Legends",
        rank_label: "Rank:",
        rank_mythic: "Mítico",
        rank_legend: "Lenda",
        rank_epic: "Épico",
        rank_grandmaster: "Grão-mestre",
        rank_master: "Mestre",
        rank_elite: "Elite",
        rank_warrior: "Guerreiro",
        days_label: "Dias:",
        days_1: "1",
        days_3: "3",
        days_7: "7",
        days_15: "15",
        days_30: "30",
        filter_title: "Filtrar por Função e Rota",
        role_label: "Função:",
        role_mage: "Mago",
        role_marksman: "Atirador",
        role_tank: "Tanque",
        role_assassin: "Assassino",
        role_fighter: "Lutador",
        role_support: "Suporte",
        all_roles: "Todas",
        lane_label: "Rota:",
        lane_mid: "Meio",
        lane_gold: "Ouro",
        lane_exp: "EXP",
        lane_jungle: "Selva",
        lane_roam: "Rotação",
        all_lanes: "Todas",
        no_heroes: "Nenhum herói encontrado."
      },
      'en-US': {
        title: "Tier List - Mobile Legends",
        rank_label: "Rank:",
        rank_mythic: "Mythic",
        rank_legend: "Legend",
        rank_epic: "Epic",
        rank_grandmaster: "Grandmaster",
        rank_master: "Master",
        rank_elite: "Elite",
        rank_warrior: "Warrior",
        days_label: "Days:",
        days_1: "1",
        days_3: "3",
        days_7: "7",
        days_15: "15",
        days_30: "30",
        filter_title: "Filter by Role and Lane",
        role_label: "Role:",
        role_mage: "Mage",
        role_marksman: "Marksman",
        role_tank: "Tank",
        role_assassin: "Assassin",
        role_fighter: "Fighter",
        role_support: "Support",
        all_roles: "All",
        lane_label: "Lane:",
        lane_mid: "Mid",
        lane_gold: "Gold",
        lane_exp: "EXP",
        lane_jungle: "Jungle",
        lane_roam: "Roam",
        all_lanes: "All",
        no_heroes: "No heroes found."
      }
    };

    let heroIdToName = {};
    let heroNameToId = {};
    let heroExtraInfo = {};
    let tierCards = [];
    let tierRecords = [];
    let currentLang = 'pt-BR';

    function fetchHeroMap() {
      return fetch('https://mlbb-proxy.vercel.app/api/hero-list')
        .then(res => res.json())
        .then(map => {
          heroIdToName = map;
          heroNameToId = {};
          Object.entries(map).forEach(([id, name]) => {
            heroNameToId[name] = id;
          });
        });
    }

    function fetchAllHeroPositions() {
      return fetch('https://mlbb-proxy.vercel.app/api/hero-position?role=all&lane=all&size=127&index=1')
        .then(res => res.json())
        .then(json => {
          heroExtraInfo = {};
          (json.data.records || []).forEach(entry => {
            const heroData = entry.data;
            heroExtraInfo[String(heroData.hero_id)] = {
              role: (heroData.hero && heroData.hero.data && heroData.hero.data.sortid &&
                heroData.hero.data.sortid.length && heroData.hero.data.sortid[0] &&
                heroData.hero.data.sortid[0].data && heroData.hero.data.sortid[0].data.sort_title)
                ? heroData.hero.data.sortid[0].data.sort_title.toLowerCase() : "",
              roadsort: (heroData.hero && heroData.hero.data && heroData.hero.data.roadsort)
                ? heroData.hero.data.roadsort : []
            };
          });
        });
    }

    function carregarTierList() {
      const rank = document.getElementById('rank').value;
      const days = document.getElementById('days').value;
      const url = `https://mlbb-proxy.vercel.app/api/hero-rank?source=rank&days=${days}&rank=${rank}&size=130&sort_field=win_rate&sort_order=desc`;

      document.getElementById('tier-ss').innerHTML = '';
      document.getElementById('tier-s').innerHTML = '';
      document.getElementById('tier-a').innerHTML = '';
      document.getElementById('noResults').classList.add('hidden');
      tierCards = [];
      tierRecords = [];

      Promise.all([fetchHeroMap(), fetchAllHeroPositions(), fetch(url).then(res => res.json())])
        .then(([_, __, json]) => {
          const records = json.data.records || [];
          tierRecords = records;
          let count = {ss:0,s:0,a:0};

          records.forEach(entry => {
            const hero = entry.data.main_hero.data;
            const winRate = (entry.data.main_hero_win_rate * 100).toFixed(1);
            const heroId = heroNameToId[hero.name];
            const info = heroExtraInfo[heroId] || {};
            let roadsortTitles = [];
            let iconCount = 0;
            let roadsortHtml = '';

            if (Array.isArray(info.roadsort) && info.roadsort.length > 0) {
              roadsortTitles = info.roadsort.map(rs =>
                (rs.data && rs.data.road_sort_title) ? rs.data.road_sort_title : ''
              ).filter(Boolean);
              iconCount = info.roadsort.length;
              roadsortHtml = info.roadsort.map(rs => {
                const data = rs.data || {};
                return data.road_sort_icon
                  ? `<span class="hero-route"><img src="${data.road_sort_icon}" alt="" title="${data.road_sort_title}" width="60" height="60"></span>`
                  : '';
              }).join('');
            }

            const el = document.createElement('div');
            el.className = 'card';
            el.setAttribute('data-role', (info.role || '').toLowerCase());
            el.setAttribute('data-routes', roadsortTitles.join('|').toLowerCase());
            el.setAttribute('data-id', heroId || '');
            el.setAttribute('data-name', hero.name);

            el.innerHTML = `
              <img src="${hero.head}" alt="Retrato do herói ${hero.name}" loading="lazy">
              <div class="hero-name">${hero.name}</div>
              <div class="hero-meta">${winRate}% WR</div>
              <div class="hero-routes ${iconCount === 1 ? 'single' : ''}">${roadsortHtml}</div>
            `;

            tierCards.push(el);

            if (winRate >= 54) {
              document.getElementById('tier-ss').appendChild(el); count.ss++;
            } else if (winRate >= 51) {
              document.getElementById('tier-s').appendChild(el); count.s++;
            } else {
              document.getElementById('tier-a').appendChild(el); count.a++;
            }
          });

          if (!count.ss && !count.s && !count.a) {
            document.getElementById('noResults').classList.remove('hidden');
          }
          filtrarTierList(); // faz filtro se já está selecionado
        })
        .catch(err => {
          document.getElementById('noResults').classList.remove('hidden');
        });
    }

    function filtrarTierList() {
      const role = document.getElementById('role').value.toLowerCase();
      const lane = document.getElementById('lane').value.toLowerCase();
      let visible = 0;
      document.querySelectorAll('.tier-container .card').forEach(card => {
        const heroRole = (card.getAttribute('data-role') || '').toLowerCase();
        const heroRoutes = (card.getAttribute('data-routes') || '').toLowerCase();
        let mostra = true;
        if (role && !heroRole.includes(role)) mostra = false;
        if (lane && !heroRoutes.includes(lane)) mostra = false;
        card.classList.toggle('hidden', !mostra);
        if (mostra) visible++;
      });
      document.getElementById('noResults').classList.toggle('hidden', visible !== 0);
    }

    // Tradução dinâmica
    function translate(key) {
      return translations[currentLang][key] || key;
    }
    function updateI18n() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
          el.textContent = translations[currentLang][key];
        }
      });
      // Atualizar options de selects
      document.querySelectorAll('option[data-i18n]').forEach(opt => {
        const key = opt.getAttribute('data-i18n');
        if (translations[currentLang][key]) {
          opt.textContent = translations[currentLang][key];
        }
      });
    }

    // Modo noturno
    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      let icon = document.getElementById('themeIcon');
      if (theme === "dark") {
        icon.className = "fa-solid fa-sun";
      } else {
        icon.className = "fa-solid fa-moon";
      }
      localStorage.setItem('theme', theme);
    }
    function toggleTheme() {
      const newTheme = document.body.getAttribute('data-theme') === "dark" ? "light" : "dark";
      setTheme(newTheme);
    }
    (function() {
      let theme = localStorage.getItem('theme');
      if (!theme) {
        theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? "dark" : "light";
      }
      setTheme(theme);
    })();

    // Troca de idioma
    function showFlagDropdown(show) {
      document.getElementById('flagDropdown').classList.toggle('hidden', !show);
    }
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      updateI18n();
      carregarTierList();
      // flags
      document.getElementById('langFlag').style.backgroundImage =
        lang === "pt-BR"
          ? "url('https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/br.svg')"
          : "url('https://cdn.jsdelivr.net/gh/hjnilsson/country-flags/svg/us.svg')";
      document.getElementById('flagBR').classList.toggle('selected', lang === "pt-BR");
      document.getElementById('flagUS').classList.toggle('selected', lang === "en-US");
      localStorage.setItem('lang', lang);
    }

    document.addEventListener('DOMContentLoaded', function () {
      // idioma
      let lang = localStorage.getItem('lang');
      if (!lang) lang = navigator.language === "en-US" ? "en-US" : "pt-BR";
      setLanguage(lang);

      carregarTierList();
      document.getElementById('rank').addEventListener('change', carregarTierList);
      document.getElementById('days').addEventListener('change', carregarTierList);
      document.getElementById('role').addEventListener('change', filtrarTierList);
      document.getElementById('lane').addEventListener('change', filtrarTierList);

      // Theme switch
      document.getElementById('themeSwitch').addEventListener('click', toggleTheme);

      // Language switch
      const langSwitch = document.getElementById('langSwitch');
      langSwitch.addEventListener('click', function(e) {
        showFlagDropdown(true);
        e.stopPropagation();
      });
      document.getElementById('flagBR').addEventListener('click', function() { setLanguage('pt-BR'); showFlagDropdown(false); });
      document.getElementById('flagUS').addEventListener('click', function() { setLanguage('en-US'); showFlagDropdown(false); });
      // fechar dropdown ao clicar fora
      document.addEventListener('click', function(e) {
        if (!document.getElementById('flagDropdown').contains(e.target) && e.target !== langSwitch) {
          showFlagDropdown(false);
        }
      });
      // acessibilidade: teclado
      document.getElementById('flagBR').addEventListener('keypress', function(e){ if(e.key==='Enter'){setLanguage('pt-BR');showFlagDropdown(false);} });
      document.getElementById('flagUS').addEventListener('keypress', function(e){ if(e.key==='Enter'){setLanguage('en-US');showFlagDropdown(false);} });
    });
  </script>
</body>
</html>
