<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tier List MLBB</title>
  <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
  <h1>Tier List - Mobile Legends</h1>
  <label for="rank">Rank:</label>
  <select id="rank">
    <option value="mythic">Mythic</option>
    <option value="legend">Legend</option>
    <option value="epic">Epic</option>
    <option value="grandmaster">Grandmaster</option>
    <option value="master">Master</option>
    <option value="elite">Elite</option>
    <option value="warrior">Warrior</option>
  </select>
  <label for="days">Dias:</label>
  <select id="days">
    <option value="1">1</option>
    <option value="3">3</option>
    <option value="7" selected>7</option>
    <option value="15">15</option>
    <option value="30">30</option>
  </select>
  <button onclick="carregarTierList()">Atualizar</button>

  <div class="tier-box tier-ss">
    <div class="tier-label ss">SS</div>
    <div id="tier-ss" class="tier-container"></div>
  </div>
  <div class="tier-box tier-s">
    <div class="tier-label s">S</div>
    <div id="tier-s" class="tier-container"></div>
  </div>
  <div class="tier-box tier-a">
    <div class="tier-label a">A</div>
    <div id="tier-a" class="tier-container"></div>
  </div>
  <div id="filter-section">
    <h2>Filtrar por Função e Rota</h2>
    <label for="role">Função:</label>
    <select id="role">
      <option value="">Todas</option>
      <option value="mage">Mage</option>
      <option value="marksman">Marksman</option>
      <option value="tank">Tank</option>
      <option value="assassin">Assassin</option>
      <option value="fighter">Fighter</option>
      <option value="support">Support</option>
    </select>
    <label for="lane">Rota:</label>
    <select id="lane">
      <option value="">Todas</option>
      <option value="mid">Mid</option>
      <option value="gold">Gold</option>
      <option value="exp">EXP</option>
      <option value="jungle">Jungle</option>
      <option value="roam">Roam</option>
    </select>
    <button onclick="filtrarPorPosicao()">Buscar</button>
    <div id="filtered-heroes"></div>
    <pre id="debug-json" style="background:#222;color:#fff;padding:10px;max-width:700px;overflow:auto;display:none"></pre>
    <button id="toggle-debug" style="margin-top:10px;">Mostrar/Esconder Debug JSON</button>
  </div>
  <script>
    function carregarTierList() {
      const rank = document.getElementById('rank').value;
      const days = document.getElementById('days').value;
      const url = `https://mlbb-proxy.vercel.app/api/hero-rank?source=rank&days=${days}&rank=${rank}&size=130&sort_field=win_rate&sort_order=desc`;

      document.getElementById('tier-ss').innerHTML = '';
      document.getElementById('tier-s').innerHTML = '';
      document.getElementById('tier-a').innerHTML = '';

      fetch(url)
        .then(res => res.json())
        .then(json => {
          const records = json.data.records || [];

          records.forEach(entry => {
            const hero = entry.data.main_hero.data;
            const winRate = (entry.data.main_hero_win_rate * 100).toFixed(1);

            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
              <img src="${hero.head}" alt="${hero.name}">
              <div class="hero-name">${hero.name}</div>
              <div class="hero-meta">${winRate}% WR</div>
              <div class="hero-role">${hero.lane || '—'}</div>
            `;

            if (winRate >= 54) {
              document.getElementById('tier-ss').appendChild(el);
            } else if (winRate >= 51) {
              document.getElementById('tier-s').appendChild(el);
            } else {
              document.getElementById('tier-a').appendChild(el);
            }
          });
        })
        .catch(err => {
          console.error("Erro ao carregar tier list:", err);
        });
    }

    function filtrarPorPosicao() {
      const role = document.getElementById('role').value;
      const lane = document.getElementById('lane').value;
      const params = new URLSearchParams();
      if (role) params.append('role', role);
      if (lane) params.append('lane', lane);
      params.append('size', 30);
      params.append('index', 1);

      const url = `https://mlbb-proxy.vercel.app/api/hero-position?${params.toString()}`;

      document.getElementById('filtered-heroes').innerHTML = '';

      fetch(url)
        .then(res => res.json())
        .then(json => {
          // DEBUG: mostra o JSON bruto retornado
          document.getElementById('debug-json').textContent = JSON.stringify(json, null, 2);
          document.getElementById('debug-json').style.display = 'none';

          const records = json.data.records || [];
          if (records.length === 0) {
            document.getElementById('filtered-heroes').innerText = 'Nenhum herói encontrado.';
            return;
          }

          records.forEach(entry => {
            // Corrigido: acesso via entry.data.hero.data
            const hero = entry.data && entry.data.hero && entry.data.hero.data ? entry.data.hero.data : null;
            if (!hero) return;
            // Mostra o id para debug
            let idHtml = hero.id ? `<div class="hero-id">ID: ${hero.id}</div>` : '<div class="hero-id" style="color:red;">ID não encontrado</div>';
            // Mostra as posições (rotas)
            let roadsortHtml = '';
            if (Array.isArray(hero.roadsort)) {
              roadsortHtml = hero.roadsort.map(rs => {
                const data = rs.data || {};
                return `
                  <div class="hero-role">
                    ${data.road_sort_icon ? `<img src="${data.road_sort_icon}" alt="${data.road_sort_title}" style="height: 24px;vertical-align:middle;">` : ''}
                    ${data.road_sort_title || ''}
                  </div>
                `;
              }).join('');
            }
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `
              <div class="hero-name">${hero.name}</div>
              ${idHtml}
              ${roadsortHtml}
            `;
            document.getElementById('filtered-heroes').appendChild(el);
          });
        })
        .catch(err => {
          document.getElementById('filtered-heroes').innerText = 'Erro ao buscar dados.';
          console.error("Erro ao filtrar heróis:", err);
        });
    }

    // Botão para mostrar/esconder debug JSON
    document.getElementById('toggle-debug').onclick = function() {
      const dbg = document.getElementById('debug-json');
      dbg.style.display = dbg.style.display === 'none' ? 'block' : 'none';
    };

    carregarTierList();
  </script>
</body>
</html>
